<!DOCTYPE html>
<html lang="cs" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <title>Seznam Pojisteni</title>
    <!-- Načítání Bootstrap CSS pro responzivní design -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
</head>
<body class="d-flex flex-column min-vh-100">

<!-- Načítání fragmentu pro navigaci -->
<div th:replace="~{fragments/navigace :: navigace}"></div>

<article class="container mt-5 mb-mb-4 flex-grow-1" id="obsah">
    <div class="col-md-9 mx-auto">
        <div id="pojisteniListPanel" class="panel">
            <h2>Seznam pojištění</h2>

            <!-- Formulář pro hledání pojištění -->
            <form action="/pojisteni/seznamPojisteni" method="get" id="formularHledani">
                <div class="form-group d-flex mt-5">
                    <input type="text" class="form-control mr-3 mt-2" id="vstupHledani" name="query" placeholder="Zadejte jméno pojištěnce" th:value="${query}">
                    <button class="btn btn-secondary mt-2 text-nowrap" type="submit" id="tlacitkoHledat">Hledat pojištění</button>
                </div>
            </form>

            <div th:if="${#lists.isEmpty(pojisteni)}" class="alert alert-info">
                V databázi zatím nejsou žádná pojištění.
            </div>

            <!-- Tabulka pro zobrazení pojištění -->
            <table class="table border table-striped mt-4">
                <thead>
                <tr>
                    <th>Pojištění</th>
                    <th>Pojištěnec</th>
                    <th>Částka</th>
                    <th>Akce</th>
                </tr>
                </thead>
                <tbody id="seznamPojisteni">
                <!-- Iterace přes seznam pojištění a zobrazení detailů -->
                <tr th:each="pojisteniItem : ${pojisteni}">
                    <td>
                        <a th:href="@{/pojisteni/pojisteniDetail/{idPojisteni}(idPojisteni=${pojisteniItem.idPojisteni})}">
                            <span th:text="${pojisteniItem.typPojisteni}"></span>
                        </a>
                    </td>
                    <td>
                        <a th:href="@{/pojistenec/pojistenecDetail/{id}(id=${pojisteniItem.pojistenec.id})}">
                            <span th:text="${pojisteniItem.pojistenec.jmeno} + ' ' + ${pojisteniItem.pojistenec.prijmenni}"></span>
                        </a>
                    </td>
                    <td>
                        <span th:text="${pojisteniItem.castka}"></span> Kč
                    </td>
                    <td>
                        <div class="d-flex">
                            <!-- Tlačítko pro úpravu pojištění -->
                            <button type="button" id="tlacitkoUpravitPojisteni" class="btn btn-sm btn-warning mr-3">
                                <a href="#" th:href="@{/upravitPojisteni/{idPojisteni}(idPojisteni=${pojisteniItem.idPojisteni})}" class="text-white">Upravit</a>
                            </button>
                            <!-- Formulář pro smazání pojištění -->
                            <form th:action="@{/delete/{idPojisteni}(idPojisteni=${pojisteniItem.idPojisteni})}"
                                  method="post"
                                  th:id="'formularProSmazani' + ${pojisteniItem.idPojisteni}">
                                <button type="button"
                                        class="btn btn-danger btn-sm"
                                        th:id="'tlacitkoSmazat' + ${pojisteniItem.idPojisteni}">
                                    Odstranit
                                </button>
                            </form>
                        </div>
                    </td>
                </tr>
                </tbody>
            </table>

            <!-- Navigace pro stránkování -->
            <nav id="strankovani" aria-label="Page navigation">
                <ul class="pagination justify-content-center">
                    <!-- Tlačítko pro předchozí stránku, zobrazuje se pouze pokud nejsme na první stránce -->
                    <li class="page-item" th:if="${soucasnaStrana > 1}">
                        <a class="page-link" th:href="@{/pojisteni/seznamPojisteni(page=${soucasnaStrana - 1}, query=${query})}" aria-label="Previous">
                            <span aria-hidden="true">&laquo;</span>
                        </a>
                    </li>

                    <!-- Čísla stránek, zobrazení všech stránek -->
                    <li class="page-item" th:each="pageNum : ${#numbers.sequence(1, celkemStran)}"
                        th:class="${pageNum == soucasnaStrana} ? 'active' : ''">
                        <a class="page-link" th:href="@{/pojisteni/seznamPojisteni(page=${pageNum}, query=${query})}" th:text="${pageNum}"></a>
                    </li>

                    <!-- Tlačítko pro další stránku, zobrazuje se pouze pokud nejsme na poslední stránce -->
                    <li class="page-item" th:if="${soucasnaStrana < celkemStran}">
                        <a class="page-link" th:href="@{/pojisteni/seznamPojisteni(page=${soucasnaStrana + 1}, query=${query})}" aria-label="Next">
                            <span aria-hidden="true">&raquo;</span>
                        </a>
                    </li>
                </ul>
            </nav>
        </div>
    </div>
</article>

<!-- Načítání fragmentu pro zápatí -->
<div th:replace="~{fragments/zapati :: zapati}"></div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Vyhledání všech tlačítek pro smazání
        var tlacitkaSmazat = document.querySelectorAll('button[id^="tlacitkoSmazat"]');

        // Event listener pro tlačítka pro smazání
        tlacitkaSmazat.forEach(function(button) {
            button.addEventListener('click', function(event) {
                var idPojisteni = button.id.replace('tlacitkoSmazat', '');
                potvrdSmazani(event, idPojisteni);
            });
        });

        // Funkce pro potvrzení a smazání pojištění
        function potvrdSmazani(event, idPojisteni) {
            event.preventDefault();  // Zabraňuje odeslání formuláře (nepoužíváme AJAX)

            // Zobrazení potvrzovacího dialogu
            var potvrzeni = confirm("Opravdu chcete smazat toto pojištění?");

            // Pokud uživatel potvrdi, odeslat formulář pro smazání
            if (potvrzeni) {
                // Najít formulář, který odpovídá konkrétnímu pojištění a odeslat ho
                var formular = document.getElementById('formularProSmazani' + idPojisteni);
                formular.submit();  // Odeslání formuláře pro smazání pojištění
            } else {
                console.log("Smazání zrušeno pro ID:", idPojisteni);  // Logování zrušení akce
            }
        }

        // Vyhledání tlačítka pro hledání, vstupního pole a těla tabulky
        var tlacitkoHledat = document.getElementById('tlacitkoHledat');
        var vstupHledani = document.getElementById('vstupHledani');
        var teloTabulky = document.querySelector('#seznamPojisteni tbody');

        // Event listener pro tlačítko hledání
        tlacitkoHledat.addEventListener('click', function(event) {
            event.preventDefault();  // Zabraňuje odeslání formuláře pro AJAX-like chování

            var hledanaHodnota = vstupHledani.value.trim();
            filtrPojisteniList(hledanaHodnota);

            // Odeslání formuláře pro hledání na backendu
            document.getElementById('formularHledani').submit();
        });

        // Funkce pro filtrování seznamu pojištění podle zadané hodnoty
        function filtrPojisteniList(hledanaHodnota) {
            var hledanyVyraz = hledanaHodnota.trim().toLowerCase();
            var radky = document.querySelectorAll('#seznamPojisteni tbody tr');

            radky.forEach(function(row) {
                var jmenoPojistence = row.querySelector('td:nth-child(2) a').textContent.trim().toLowerCase();
                var castiJmena = jmenoPojistence.split(' ');
                var krestniJmeno = castiJmena[0];
                var prijmenni = castiJmena[1] || '';

                if (krestniJmeno.toLowerCase().startsWith(hledanyVyraz) || prijmenni.toLowerCase().startsWith(hledanyVyraz)) {
                    row.style.display = ''; // Zobrazí řádek, pokud došlo k shodě
                } else {
                    row.style.display = 'none'; // Skryje řádek, pokud nebyla shoda
                }
            });
        }

        // Funkce pro vytvoření a přidání tlačítka pro resetování filtru (Zobrazit všechny)
        function vytvorTlacitkoZobrazitVsechny() {
            const teloTabulky = document.querySelector('#seznamPojisteni').parentElement;

            // Kontrola, zda tlačítko již existuje, aby nedocházelo k duplikaci
            if (!document.getElementById('tlacitkoZobrazitVsechny')) {
                var tlacitkoZobrazitVsechny = document.createElement('button');
                tlacitkoZobrazitVsechny.id = 'tlacitkoZobrazitVsechny';
                tlacitkoZobrazitVsechny.classList.add('btn', 'btn-info', 'mt-2', 'text-nowrap');
                tlacitkoZobrazitVsechny.textContent = 'Zobrazit všechny';
                tlacitkoZobrazitVsechny.style.display = 'inline-block';

                // Přidání tlačítka na konec tabulky
                teloTabulky.parentElement.appendChild(tlacitkoZobrazitVsechny);

                // Přidání event listeneru pro tlačítko "Zobrazit všechny"
                tlacitkoZobrazitVsechny.addEventListener('click', function() {
                    vstupHledani.value = '';  // Vymazání vyhledávacího pole
                    filtrPojisteniList(''); // Zobrazení všech pojištění (vymazání filtru)
                    tlacitkoZobrazitVsechny.remove();  // Smazání tlačítka "Zobrazit všechny"
                    window.location.href = '/pojisteni/seznamPojisteni'; // Načtení stránky s všemi pojištěními
                });
            }
        }

        // Zkontrolování, zda je v URL přítomen dotaz pro hledání
        const query = new URLSearchParams(window.location.search).get('query');
        if (query) {
            // Předvyplnění vyhledávacího pole
            vstupHledani.value = query;
            vytvorTlacitkoZobrazitVsechny();  // Zobrazení tlačítka pro resetování filtru
        }
    });
</script>

<!-- Načítání potřebných knihoven pro Bootstrap -->
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
</body>
</html>
