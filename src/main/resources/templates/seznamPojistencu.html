<!DOCTYPE html>
<html lang="cs" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <title>Seznam pojištěnců</title>
    <!-- Načítání Bootstrap CSS pro responzivní design -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
</head>
<body class="d-flex flex-column min-vh-100">

<!-- Načítání fragmentu pro navigaci -->
<div th:replace="~{fragments/navigace :: navigace}"></div>

<article class="container mt-5 mb-4 flex-grow-1" id="obsah">
    <div class="col-md-9 mx-auto">
        <div id="panelSeznamuPojistencu" class="panel">
            <!-- Zobrazení úspěšné zprávy, pokud existuje -->
            <div th:if="${successMessage != null}" class="alert alert-success">
                <span th:text="${successMessage}"></span>
            </div>
            <h2>Seznam pojištěnců</h2>

            <!-- Formulář pro hledání pojištěnce -->
            <div class="form-group d-flex mt-5">
                <input type="text" class="form-control mr-3 mt-2" id="vstupHledani" placeholder="Zadejte jméno" th:value="${query}">
                <button class="btn btn-secondary mt-2 text-nowrap" id="tlacitkoHledat">Hledat pojištěnce</button>
            </div>

            <div th:if="${#lists.isEmpty(pojistenci)}" class="alert alert-info">
                V databázi zatím nejsou žádní pojištěnci.
            </div>

            <!-- Tabulka pro zobrazení pojištěnců -->
            <table id="tabulkaPojistencu" class="table border table-striped mt-4">
                <thead>
                <tr>
                    <th>Jméno a Příjmení</th>
                    <th>Adresa</th>
                    <th>Akce</th>
                </tr>
                </thead>
                <tbody id="seznamPojistencu">
                <!-- Iterace přes seznam pojištěnců -->
                <tr th:each="pojistenec : ${pojistenci}">
                    <td>
                        <a th:href="@{/pojistenec/pojistenecDetail/{id}(id=${pojistenec.id})}">
                            <span th:text="${pojistenec.jmeno} + ' ' + ${pojistenec.prijmenni}">Jméno Příjmení</span>
                        </a>
                    </td>
                    <td th:text="${pojistenec.ulice + ', ' + pojistenec.mesto}"></td>
                    <td>
                        <div class="d-flex">
                            <!-- Tlačítko pro úpravu -->
                            <button id="tlacitkoUpravit" class="btn btn-sm btn-warning mr-3">
                                <a href="#" th:href="@{/pojistenec/upravitPojistence/{id}(id=${pojistenec.id})}" class="text-white">Upravit</a>
                            </button>
                            <!-- Formulář pro smazání -->
                            <!-- Formulář pro smazání -->
                            <form th:action="@{/pojistenec/delete/{id}(id=${pojistenec.id})}"
                                  method="post"
                                  th:id="'formularSmazat' + ${pojistenec.id}">
                                <button type="button"
                                        class="btn btn-danger btn-sm"
                                        th:id="'tlacitkoSmazat' + ${pojistenec.id}"
                                        th:data-name="${pojistenec.jmeno} + ' ' + ${pojistenec.prijmenni}">
                                    Odstranit
                                </button>
                            </form>
                        </div>
                    </td>
                </tr>
                </tbody>
            </table>

            <!-- Navigace pro stránkování -->
            <nav id="strankovani" aria-label="Page navigation">
                <ul class="pagination justify-content-center">
                    <!-- Tlačítko pro předchozí stránku, zobrazuje se pouze pokud nejsme na první stránce -->
                    <li class="page-item" th:if="${soucasnaStrana > 1}">
                        <a class="page-link" th:href="@{/pojistenec/seznamPojistencu(page=${soucasnaStrana - 1}, query=${query})}" aria-label="Previous">
                            <span aria-hidden="true">&laquo;</span>
                        </a>
                    </li>

                    <!-- Čísla stránek, zobrazení všech stránek -->
                    <li class="page-item" th:each="pageNum : ${#numbers.sequence(1, celkemStran)}"
                        th:class="${pageNum == soucasnaStrana ? 'active' : ''}">
                        <a class="page-link" th:href="@{/pojistenec/seznamPojistencu(page=${pageNum}, query=${query})}" th:text="${pageNum}"></a>
                    </li>

                    <!-- Tlačítko pro další stránku, zobrazuje se pouze pokud nejsme na poslední stránce -->
                    <li class="page-item" th:if="${soucasnaStrana < celkemStran}">
                        <a class="page-link" th:href="@{/pojistenec/seznamPojistencu(page=${soucasnaStrana + 1}, query=${query})}" aria-label="Next">
                            <span aria-hidden="true">&raquo;</span>
                        </a>
                    </li>
                </ul>
            </nav>
        </div>
    </div>
</article>

<!-- Načítání fragmentu pro zápatí -->
<div th:replace="~{fragments/zapati :: zapati}"></div>

<script>
    // Přidání funkce pro hledání pojištěnců podle zadání do vyhledávacího pole
    document.getElementById('tlacitkoHledat').addEventListener('click', function () {
        const query = document.getElementById('vstupHledani').value.trim();

        if (!query) {
            alert('Prosím zadejte nějaký text pro hledání.');
            return;
        }

        // Přesměrování na první stránku s vyhledávacím dotazem
        window.location.href = '/pojistenec/seznamPojistencu?page=1&query=' + encodeURIComponent(query);
    });

    // Funkce pro filtrování seznamu pojištěnců podle hledaného výrazu
    function filterPojistenciList(searchValue) {
        const hledatVyraz = searchValue.trim().toLowerCase();
        const rady = document.querySelectorAll('#seznamPojistencu tr');
        let found = false;

        rady.forEach(function(row) {
            const bunkaJmena = row.querySelector('td:nth-child(1)'); // První buňka řádku (Jméno)

            if (bunkaJmena) {
                const zakotveni = bunkaJmena.querySelector('a'); // Ověření, zda existuje tag <a>

                if (zakotveni) {
                    const textJmena = zakotveni.textContent.trim().toLowerCase(); // Získání textu jména
                    if (textJmena.startsWith(hledatVyraz)) {
                        row.style.display = ''; // Zobrazení řádku, pokud odpovídá hledanému výrazu
                        found = true;
                    } else {
                        row.style.display = 'none'; // Skrytí řádku, pokud neodpovídá
                    }
                } else {
                    row.style.display = 'none'; // Skrytí řádku, pokud není tag <a>
                }
            } else {
                row.style.display = 'none'; // Skrytí řádku, pokud první <td> chybí
            }
        });

        // Zobrazení zprávy, pokud nejsou nalezeny žádné výsledky
        const zpravaOZadnychVysledcich = document.querySelector('#zpravaOZadnychVysledcich');
        if (found) {
            // Skrytí zprávy "Žádní pojištěnci nenalezeni", pokud jsou výsledky
            if (zpravaOZadnychVysledcich) zpravaOZadnychVysledcich.style.display = 'none';
        } else {
            // Zobrazení zprávy "Žádní pojištěnci nenalezeni", pokud žádní pojištěnci odpovídají hledání
            if (!zpravaOZadnychVysledcich) {
                const radekZpravy = document.createElement('tr');
                radekZpravy.id = 'zpravaOZadnychVysledcich';  // Přiřazení ID pro snadnější nalezení později
                radekZpravy.innerHTML = `<td colspan="3" class="text-center">Žádní pojištěnci nenalezeni.</td>`;
                document.querySelector('#seznamPojistencu').appendChild(radekZpravy);
            }
        }
    }

    // Funkce pro vytvoření tlačítka pro zobrazení všech pojištěnců
    function vytvorTlacitkoZobrazitVsechny() {
        const teloTabulky = document.querySelector('#seznamPojistencu').parentElement;

        // Kontrola, zda tlačítko již existuje, aby se nevytvářelo zbytečně
        if (!document.getElementById('tlacitkoZobrazitVsechny')) {
            var tlacitkoZobrazitVsechny = document.createElement('button');
            tlacitkoZobrazitVsechny.id = 'tlacitkoZobrazitVsechny';
            tlacitkoZobrazitVsechny.classList.add('btn', 'btn-info', 'mt-2', 'text-nowrap');
            tlacitkoZobrazitVsechny.textContent = 'Zobrazit všechny';
            tlacitkoZobrazitVsechny.style.display = 'inline-block';

            // Přidání tlačítka po tabulce
            teloTabulky.parentElement.appendChild(tlacitkoZobrazitVsechny);

            // Přidání event listeneru pro tlačítko "Zobrazit všechny"
            tlacitkoZobrazitVsechny.addEventListener('click', function() {
                document.getElementById('vstupHledani').value = ''; // Vymazání vyhledávacího pole
                filterPojistenciList(''); // Zobrazení všech pojištěnců (vymazání filtru)
                tlacitkoZobrazitVsechny.remove(); // Smazání tlačítka "Zobrazit všechny"
                window.location.href = '/pojistenec/seznamPojistencu?page=1'; // Načtení stránky s všemi pojištěnci
            });
        }
    }

    // Kontrola, zda je vyhledávací dotaz v URL a pokud ano, zobrazit tlačítko pro zobrazení všech
    const query = new URLSearchParams(window.location.search).get('query');
    if (query) {
        document.getElementById('vstupHledani').value = query;  // Předvyplnění vyhledávacího pole
        vytvorTlacitkoZobrazitVsechny();  // Zobrazení tlačítka pro zobrazení všech pojištěnců
    }

    // Potvrzení před smazáním pojištěnce
    document.querySelectorAll('.btn-danger').forEach(function(tlacitkoSmazat) {
        tlacitkoSmazat.addEventListener('click', function(event) {
            const id = event.target.id.replace('tlacitkoSmazat', '');  // Extrahujeme ID pojištěnce
            const formular = document.getElementById('formularSmazat' + id);  // Získáme formulář pro dané ID
            const jmeno = event.target.getAttribute('data-name');  // Získáme jméno pojištěnce

            // Potvrzení před smazáním
            const potvrzeni = confirm(`Opravdu chcete odstranit pojištěnce: ${jmeno}?`);

            if (potvrzeni) {
                formular.submit();  // Odeslání formuláře, pokud uživatel potvrdí
            }
        });
    });
</script>

<!-- Načítání potřebných knihoven pro Bootstrap -->
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
</body>
</html>
